<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script>
    // redirect if user is not logged in
    const token = localStorage.getItem('token');
    if (!token) {
      window.location.href = '../index.html';
    }

    fetch('https://treasurehunt-backend-nine.vercel.app/leaderboard/completed-rounds', {
      method: 'GET',
      headers: {
        Authorization: token,
        'Content-Type': 'application/json',
      }
    })
      .then(res => res.json())
      .then(data => {
        if (data.completedRounds === 11) {
          window.location.href = './completed.html';
        }
      })
      .catch(err => {
        console.error(err);
      });


    fetch('https://treasurehunt-backend-nine.vercel.app/event/current-round', {
      method: 'GET',
      headers: {
        Authorization: token,
        'Content-Type': 'application/json',
      }
    })
      .then(res => res.json())
      .then(data => {
        if (data.currentRound !== '8') {
          window.location.href = './menu.html';
        }
      })
      .catch(err => {
        window.location.href = './menu.html';
      });

  </script>
</head>
<body>
  <button id="logout">Log out</button>
  <h1>Last Round</h1>
    <nav>
      <ul id="links"></ul>
    </nav>
  <div id="error"></div>
  <a href="./leaderboard.html">Leaderboard</a>
  <script>
    const logout = () => {
      localStorage.removeItem('token');
      window.location.href = '../index.html';
    };

    document.getElementById('logout').addEventListener('click', logout);

    const createButton = function(round) {
      const btn = document.createElement('button');
      btn.id = round;
      btn.textContent = `Round 8${round}`;

      btn.addEventListener('click', async event => {
        const round = event.currentTarget.id;

        const response = await fetch(`https://treasurehunt-backend-nine.vercel.app/event/last/${round}`, {
          method: 'POST',
          headers: {
            Authorization: token,
            'Content-Type': 'application/json',
          }
        });

        if (!response.ok) {
          const data = await response.json();
          console.error(data);
          return;
        }

        const data = await response.json();
        const { roundToken } = data;

        localStorage.setItem('last-round-token', roundToken);

        window.location.href = './last-round.html';
      });
      return btn;
    }

    fetch('https://treasurehunt-backend-nine.vercel.app/event/last/available-rounds', {
      method: 'GET',
      headers: {
        Authorization: token,
        'Content-Type': 'application/json',
      },
    })
      .then(res => res.json())
      .then(data => {
        const links = document.getElementById('links');
        data.availableRounds?.forEach(round => {
          const btn = createButton(round);
          links.appendChild(btn);
        });
      });
  </script>
</body>
</html>