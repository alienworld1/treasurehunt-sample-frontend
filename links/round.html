<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Document</title>
  <script>
      // redirect if user is not logged in
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '../index.html';
      }    
      
      function extractGoogleDriveFileId(url) {
        // Regular expression to match Google Drive file ID patterns
        const patterns = [
          /\/file\/d\/([a-zA-Z0-9_-]{33})/,  // Format: /file/d/{fileId}
          /id=([a-zA-Z0-9_-]{33})/,          // Format: id={fileId}
          /([a-zA-Z0-9_-]{33})/              // Fallback: try to match any 33-character ID
        ];

        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match && match[1]) {
            // Remove the last character
            return match[1];
          }
        }

        // If no match is found, return null
        return null;
      }
  </script>
</head>
<body>
  <!-- If there's an image, it will be displayed here: -->
  <div id="image"></div>

  <div id="timer"></div>
  <form action="" method="post" id="question-form">
    <fieldset>
      <legend>Question</legend>
      <p id="question"></p>
      <label for="solution" id="questionlabel">Loading question...</label>
      <input type="text" id="solution" name="solution" placeholder="Your answer goes here..." required>
      <button type="submit">Submit</button>
      <div id="error" style="color: red;"></div>
    </fieldset>
  </form>
  <div id="hint"></div>
  <div class="correct" style="color: green;"></div>
  <script>
    const questionForm = document.getElementById('question-form');
    const error = document.getElementById('error');

    const questionLabel = document.getElementById('questionlabel');
    const questionElement = document.getElementById('question');

    let hint = null;

    function startCountdown(endTime) {
      let interval;
      function updateTimer() {
          let now = new Date();
          let timeDiff = endTime - now;

          if (timeDiff <= 0) {
              clearInterval(interval);
              document.getElementById('timer').innerText = '00:00';
              document.getElementById('hint').innerText = hint ?? 'No hint available';
              return;
          }

          let minutes = Math.floor(timeDiff / 60000);
          let seconds = Math.floor((timeDiff % 60000) / 1000);

          document.getElementById('timer').innerText = 
              `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

      updateTimer();
      setInterval(updateTimer, 1000);
    } 

    fetch('https://treasurehunt-backend-nine.vercel.app/event/round', {
      headers: {
        Authorization: token,
        'Content-Type': 'application/json',
      },
    })
      .then(response => {
        if (!response.ok) {
          throw new Error('You are not authorized to view this page');
        }
        return response.json();
      })
      .then(data => {
        console.log(data);
        questionLabel.textContent = data.question;
        if (data.round === '4') {
          questionLabel.innerHTML = `<a href="${data.question}" target="_blank">Download the minigame here</a>`;
        }
        questionElement.textContent = data.hint;
        if (data.image_url) {
          const imageId = extractGoogleDriveFileId(data.image_url);
          const imageUrl = `https://drive.google.com/thumbnail?id=${imageId}`;
          document.getElementById('image').innerHTML = `<img src=${imageUrl}>`;
        }
        hint = data.questionHint;

        const timeAlloted = data.round === '4' ? 20 * 60000 : 10 * 60000;

        const endTime = data.startTime ? 
          new Date(data.startTime).getTime() + timeAlloted : 
          new Date().getTime() + timeAlloted;

        startCountdown(new Date(endTime));
      })
      .catch(err => {
        console.error(err);
        // window.location.href = '../index.html';
      });
    
    questionForm.addEventListener('submit', async e => {
      e.preventDefault();

      const response = await fetch('https://treasurehunt-backend-nine.vercel.app/event/validate', {
        headers: {
          Authorization: token,
          'Content-Type': 'application/json',
        },
        method: 'POST',
        body: JSON.stringify({ solution: document.getElementById('solution').value }),
      });

      if (!response.ok) {
        const error = await response.json();
        document.getElementById('error').textContent = error.message;
        return;
      }

      const data = await response.json();
      if (!data.isCorrect) {
        document.getElementById('error').textContent = 'Incorrect answer';
        return;
      }

      // update the round, by making a put request to round
      const roundResponse = await fetch('https://treasurehunt-backend-nine.vercel.app/event/round', {
        headers: {
          Authorization: token,
          'Content-Type': 'application/json',
        },
        method: 'PUT',
      });

      const roundData = await roundResponse.json();
      if (roundData.newRound === '8') {
        window.location.href = './last-round-menu.html';
        return;
      }

      error.textContent = '';
      document.querySelector('.correct').innerHTML = '<p>Correct answer!</p> Go back to <a href="./menu.html">menu</a>';
    });
  </script>
</body>
</html>